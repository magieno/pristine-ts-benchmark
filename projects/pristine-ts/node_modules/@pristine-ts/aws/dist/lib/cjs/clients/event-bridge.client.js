"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventBridgeClient = void 0;
const tsyringe_1 = require("tsyringe");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
const event_bridge_send_message_error_1 = require("../errors/event-bridge-send-message.error");
const common_1 = require("@pristine-ts/common");
const aws_module_keyname_1 = require("../aws.module.keyname");
/**
 * The client to use to interact with AWS Event Bridge. It is a wrapper around the AwsEventBridgeClient of @aws-sdk/client-eventbridge.
 * It is tagged so it can be injected using EventBridgeClientInterface.
 */
let EventBridgeClient = class EventBridgeClient {
    /**
     * The client to use to interact with AWS Event Bridge. It is a wrapper around the AwsEventBridgeClient of @aws-sdk/client-eventbridge.
     * @param logHandler The log handler used to output logs.
     * @param region The aws region for which the client will be used.
     */
    constructor(logHandler, region) {
        this.logHandler = logHandler;
        this.region = region;
    }
    /**
     * Returns the instantiated AwsEventBridgeClient from the @aws-sdk/client-eventbridge library.
     * @param endpoint The endpoint for which the Event Bridge client is created.
     */
    getClient(endpoint) {
        return new client_eventbridge_1.EventBridgeClient({
            apiVersion: "2015-10-17",
            region: this.region,
            endpoint: endpoint !== null && endpoint !== void 0 ? endpoint : undefined,
        });
    }
    /**
     * Sends an event to event bridge.
     * @param eventBridgeMessages The messages to send to event bridge.
     * @param eventBusName The event bus name where to send the messages.
     * @param endpoint The endpoint for event bridge.
     */
    send(eventBridgeMessages, eventBusName, endpoint) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const client = this.getClient(endpoint);
                const putEventsCommand = new client_eventbridge_1.PutEventsCommand({
                    Entries: []
                });
                this.logHandler.debug("Sending a message to the EventBridge", {
                    eventBridgeMessages,
                    eventBusName,
                    endpoint,
                }, aws_module_keyname_1.AwsModuleKeyname);
                if (Array.isArray(eventBridgeMessages)) {
                    putEventsCommand.input.Entries = eventBridgeMessages.map(eventBridgeMessage => {
                        return {
                            EventBusName: eventBusName,
                            Source: eventBridgeMessage.source,
                            DetailType: eventBridgeMessage.detailType,
                            Detail: eventBridgeMessage.detail,
                            Resources: eventBridgeMessage.resources,
                        };
                    });
                }
                else {
                    putEventsCommand.input.Entries = [{
                            EventBusName: eventBusName,
                            Source: eventBridgeMessages.source,
                            DetailType: eventBridgeMessages.detailType,
                            Detail: eventBridgeMessages.detail,
                            Resources: eventBridgeMessages.resources,
                        }];
                }
                const response = yield client.send(putEventsCommand);
                this.logHandler.debug("Message successfully sent to the EventBridge", {
                    eventBridgeMessages,
                    eventBusName,
                    endpoint,
                    response,
                }, aws_module_keyname_1.AwsModuleKeyname);
            }
            catch (error) {
                this.logHandler.error("There was an error sending the message to the Event Bus", {
                    error,
                    eventBridgeMessages,
                    eventBusName,
                    endpoint,
                }, aws_module_keyname_1.AwsModuleKeyname);
                throw new event_bridge_send_message_error_1.EventBridgeSendMessageError(error);
            }
        });
    }
};
EventBridgeClient = __decorate([
    (0, common_1.tag)("EventBridgeClientInterface"),
    (0, common_1.moduleScoped)(aws_module_keyname_1.AwsModuleKeyname),
    (0, tsyringe_1.injectable)(),
    __param(0, (0, tsyringe_1.inject)("LogHandlerInterface")),
    __param(1, (0, tsyringe_1.inject)("%pristine.aws.region%")),
    __metadata("design:paramtypes", [Object, String])
], EventBridgeClient);
exports.EventBridgeClient = EventBridgeClient;
//# sourceMappingURL=event-bridge.client.js.map